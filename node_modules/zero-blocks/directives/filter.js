"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require("@angular/core");
var common_1 = require("@angular/common");
var FilterDirective = (function () {
    function FilterDirective(element, renderer) {
        this.element = element;
        this.filtering = new core_1.EventEmitter(false); // synchronous event emitter
        this.filtered = new core_1.EventEmitter();
    }
    FilterDirective.prototype.ngOnChanges = function (changes) {
        // Detect only changes of input value
        if (changes["filterOptions"] &&
            changes["filterOptions"].currentValue &&
            changes["filterOptions"].currentValue["inputValue"] !== undefined &&
            changes["filterOptions"].previousValue &&
            changes["filterOptions"].currentValue["inputValue"] !== changes["filterOptions"].previousValue["inputValue"]) {
            this.filter();
        }
    };
    FilterDirective.prototype.filter = function () {
        if (!this.filterOptions.items) {
            return;
        }
        var args = { cancel: false, items: this.filterOptions.items };
        this.filtering.emit(args);
        if (args.cancel) {
            return;
        }
        var pipe = new FilterPipe();
        var filtered = pipe.transform(this.filterOptions.items, this.filterOptions);
        this.filtered.emit({ filteredItems: filtered });
    };
    __decorate([
        core_1.Output(), 
        __metadata('design:type', Object)
    ], FilterDirective.prototype, "filtering", void 0);
    __decorate([
        // synchronous event emitter
        core_1.Output(), 
        __metadata('design:type', Object)
    ], FilterDirective.prototype, "filtered", void 0);
    __decorate([
        core_1.Input("filter"), 
        __metadata('design:type', FilterOptions)
    ], FilterDirective.prototype, "filterOptions", void 0);
    FilterDirective = __decorate([
        core_1.Directive({
            selector: '[filter]',
        }), 
        __metadata('design:paramtypes', [core_1.ElementRef, core_1.Renderer])
    ], FilterDirective);
    return FilterDirective;
}());
exports.FilterDirective = FilterDirective;
var FilterPipe = (function () {
    function FilterPipe() {
    }
    FilterPipe.prototype.transform = function (items, 
        // options - initial settings of filter functionality
        options) {
        var result = [];
        if (!items || !items.length || !options) {
            return;
        }
        if (options.items) {
            items = options.items;
        }
        result = items.filter(function (item) {
            var match = options.matchFn(options.formatter(options.get_value(item, options.key)), options.inputValue);
            if (match) {
                if (options.metConditionFn) {
                    options.metConditionFn(item);
                }
            }
            else {
                if (options.overdueConditionFn) {
                    options.overdueConditionFn(item);
                }
            }
            return match;
        });
        return result;
    };
    FilterPipe = __decorate([
        core_1.Pipe({
            name: "filter",
            pure: false
        }), 
        __metadata('design:paramtypes', [])
    ], FilterPipe);
    return FilterPipe;
}());
exports.FilterPipe = FilterPipe;
var FilterOptions = (function () {
    function FilterOptions() {
        // Input text value that will be used as a filtering pattern (matching condition is based on it)
        this.inputValue = "";
    }
    // Function - get value to be tested from the item
    // item - single item of the list to be filtered
    // key - property name of item, which value should be tested
    // Default behavior - returns "key"- named property value of item if key si provided, otherwise textContent of the item's html element
    FilterOptions.prototype.get_value = function (item, key) {
        var result = "";
        if (key) {
            result = item[key].toString();
        }
        else if (item.element && item.element.nativeElement) {
            result = item.element.nativeElement.textContent.trim();
        }
        return result;
    };
    // Function - formats the original text before matching process
    // Default behavior - returns text to lower case
    FilterOptions.prototype.formatter = function (valueToTest) {
        return valueToTest.toLowerCase();
    };
    ;
    // Function - determines whether the item met the condition
    // valueToTest - text value that should be tested
    // inputValue - text value from input that condition is based on
    // Default behavior - "contains"
    FilterOptions.prototype.matchFn = function (valueToTest, inputValue) {
        return valueToTest.indexOf(inputValue && inputValue.toLowerCase() || "") > -1;
    };
    ;
    // Function - executed after matching test for every matched item
    // Default behavior - shows the item
    FilterOptions.prototype.metConditionFn = function (item) {
        if (item.hasOwnProperty("hidden")) {
            item.hidden = false;
        }
    };
    ;
    // Function - executed for every NOT matched item after matching test
    // Default behavior - hides the item
    FilterOptions.prototype.overdueConditionFn = function (item) {
        if (item.hasOwnProperty("hidden")) {
            item.hidden = true;
        }
    };
    ;
    return FilterOptions;
}());
exports.FilterOptions = FilterOptions;
var FilterModule = (function () {
    function FilterModule() {
    }
    FilterModule = __decorate([
        core_1.NgModule({
            declarations: [FilterDirective, FilterPipe],
            imports: [common_1.CommonModule],
            exports: [FilterDirective, FilterPipe]
        }), 
        __metadata('design:paramtypes', [])
    ], FilterModule);
    return FilterModule;
}());
exports.FilterModule = FilterModule;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RyxJQUFJLENBQUM7UUFDdkIsQ0FBQztJQUNMLENBQUM7O0lBQ0wsb0JBQUM7QUFBRCxDQXZEQSxBQXVEQyxJQUFBO0FBdkRZLHFCQUFhLGdCQXVEekIsQ0FBQTtBQU9EO0lBQUE7SUFDQSxDQUFDO0lBTkQ7UUFBQyxlQUFRLENBQUM7WUFDTixZQUFZLEVBQUUsQ0FBQyxlQUFlLEVBQUUsVUFBVSxDQUFDO1lBQzNDLE9BQU8sRUFBRSxDQUFDLHFCQUFZLENBQUM7WUFDdkIsT0FBTyxFQUFFLENBQUMsZUFBZSxFQUFFLFVBQVUsQ0FBQztTQUN6QyxDQUFDOztvQkFBQTtJQUVGLG1CQUFDO0FBQUQsQ0FEQSxBQUNDLElBQUE7QUFEWSxvQkFBWSxlQUN4QixDQUFBIiwiZmlsZSI6ImRpcmVjdGl2ZXMvZmlsdGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBQaXBlLCBQaXBlVHJhbnNmb3JtLCBOZ01vZHVsZSwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIEVsZW1lbnRSZWYsIFJlbmRlcmVyLCBJbnB1dCwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IENvbW1vbk1vZHVsZSB9IGZyb20gXCJAYW5ndWxhci9jb21tb25cIjtcblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbZmlsdGVyXScsXG59KVxuZXhwb3J0IGNsYXNzIEZpbHRlckRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcyB7XG4gICAgQE91dHB1dCgpIGZpbHRlcmluZyA9IG5ldyBFdmVudEVtaXR0ZXIoZmFsc2UpOyAvLyBzeW5jaHJvbm91cyBldmVudCBlbWl0dGVyXG4gICAgQE91dHB1dCgpIGZpbHRlcmVkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgQElucHV0KFwiZmlsdGVyXCIpIGZpbHRlck9wdGlvbnM6IEZpbHRlck9wdGlvbnM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnQ6IEVsZW1lbnRSZWYsIHJlbmRlcmVyOiBSZW5kZXJlcikge1xuICAgIH1cblxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICAgICAgLy8gRGV0ZWN0IG9ubHkgY2hhbmdlcyBvZiBpbnB1dCB2YWx1ZVxuICAgICAgICBpZiAoY2hhbmdlc1tcImZpbHRlck9wdGlvbnNcIl0gJiZcbiAgICAgICAgICAgIGNoYW5nZXNbXCJmaWx0ZXJPcHRpb25zXCJdLmN1cnJlbnRWYWx1ZSAmJlxuICAgICAgICAgICAgY2hhbmdlc1tcImZpbHRlck9wdGlvbnNcIl0uY3VycmVudFZhbHVlW1wiaW5wdXRWYWx1ZVwiXSAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgICAgICBjaGFuZ2VzW1wiZmlsdGVyT3B0aW9uc1wiXS5wcmV2aW91c1ZhbHVlICYmXG4gICAgICAgICAgICBjaGFuZ2VzW1wiZmlsdGVyT3B0aW9uc1wiXS5jdXJyZW50VmFsdWVbXCJpbnB1dFZhbHVlXCJdICE9PSBjaGFuZ2VzW1wiZmlsdGVyT3B0aW9uc1wiXS5wcmV2aW91c1ZhbHVlW1wiaW5wdXRWYWx1ZVwiXSkge1xuICAgICAgICAgICAgdGhpcy5maWx0ZXIoKTtcbiAgICAgICAgfSAgICBcbiAgICB9XG5cbiAgICBwcml2YXRlIGZpbHRlcigpIHtcbiAgICAgICAgaWYgKCF0aGlzLmZpbHRlck9wdGlvbnMuaXRlbXMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBhcmdzID0geyBjYW5jZWw6IGZhbHNlLCBpdGVtczogdGhpcy5maWx0ZXJPcHRpb25zLml0ZW1zIH07XG4gICAgICAgIHRoaXMuZmlsdGVyaW5nLmVtaXQoYXJncyk7XG5cbiAgICAgICAgaWYgKGFyZ3MuY2FuY2VsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHZhciBwaXBlID0gbmV3IEZpbHRlclBpcGUoKTtcblxuICAgICAgICB2YXIgZmlsdGVyZWQgPSBwaXBlLnRyYW5zZm9ybSh0aGlzLmZpbHRlck9wdGlvbnMuaXRlbXMsIHRoaXMuZmlsdGVyT3B0aW9ucyk7XG4gICAgICAgIHRoaXMuZmlsdGVyZWQuZW1pdCh7IGZpbHRlcmVkSXRlbXM6IGZpbHRlcmVkIH0pO1xuICAgIH0gICBcbn1cblxuQFBpcGUoe1xuICAgIG5hbWU6IFwiZmlsdGVyXCIsXG4gICAgcHVyZTogZmFsc2Vcbn0pXG5cbmV4cG9ydCBjbGFzcyBGaWx0ZXJQaXBlIGltcGxlbWVudHMgUGlwZVRyYW5zZm9ybSB7XG4gICAgdHJhbnNmb3JtKGl0ZW1zOiBBcnJheTxhbnk+LFxuICAgICAgICAvLyBvcHRpb25zIC0gaW5pdGlhbCBzZXR0aW5ncyBvZiBmaWx0ZXIgZnVuY3Rpb25hbGl0eVxuICAgICAgICBvcHRpb25zOiBGaWx0ZXJPcHRpb25zKSB7XG5cbiAgICAgICAgdmFyIHJlc3VsdCA9IFtdO1xuXG4gICAgICAgIGlmICghaXRlbXMgfHwgIWl0ZW1zLmxlbmd0aCB8fCAhb3B0aW9ucykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wdGlvbnMuaXRlbXMpIHtcbiAgICAgICAgICAgIGl0ZW1zID0gb3B0aW9ucy5pdGVtcztcbiAgICAgICAgfVxuXG4gICAgICAgIHJlc3VsdCA9IGl0ZW1zLmZpbHRlcigoaXRlbTogYW55KSA9PiB7XG4gICAgICAgICAgICBsZXQgbWF0Y2ggPSBvcHRpb25zLm1hdGNoRm4ob3B0aW9ucy5mb3JtYXR0ZXIob3B0aW9ucy5nZXRfdmFsdWUoaXRlbSwgb3B0aW9ucy5rZXkpKSwgb3B0aW9ucy5pbnB1dFZhbHVlKTtcblxuICAgICAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMubWV0Q29uZGl0aW9uRm4pIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5tZXRDb25kaXRpb25GbihpdGVtKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLm92ZXJkdWVDb25kaXRpb25Gbikge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm92ZXJkdWVDb25kaXRpb25GbihpdGVtKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBtYXRjaDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9ICAgIFxufVxuXG5leHBvcnQgY2xhc3MgRmlsdGVyT3B0aW9ucyB7XG4gICAgLy8gSW5wdXQgdGV4dCB2YWx1ZSB0aGF0IHdpbGwgYmUgdXNlZCBhcyBhIGZpbHRlcmluZyBwYXR0ZXJuIChtYXRjaGluZyBjb25kaXRpb24gaXMgYmFzZWQgb24gaXQpXG4gICAgcHVibGljIGlucHV0VmFsdWU6IHN0cmluZyA9IFwiXCI7XG5cbiAgICAvLyBJdGVtIHByb3BlcnR5LCB3aGljaCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBmb3IgZmlsdGVyaW5nXG4gICAgcHVibGljIGtleTogc3RyaW5nO1xuXG4gICAgLy8gUmVwcmVzZW50IGl0ZW1zIG9mIHRoZSBsaXN0LiBJdCBzaG91bGQgYmUgdXNlZCB0byBoYW5kbGUgZGVjYWxhcmF0ZXZlbHkgZGVmaW5lZCB3aWRnZXRzXG4gICAgcHVibGljIGl0ZW1zOiBBcnJheTxhbnk+O1xuXG4gICAgLy8gRnVuY3Rpb24gLSBnZXQgdmFsdWUgdG8gYmUgdGVzdGVkIGZyb20gdGhlIGl0ZW1cbiAgICAvLyBpdGVtIC0gc2luZ2xlIGl0ZW0gb2YgdGhlIGxpc3QgdG8gYmUgZmlsdGVyZWRcbiAgICAvLyBrZXkgLSBwcm9wZXJ0eSBuYW1lIG9mIGl0ZW0sIHdoaWNoIHZhbHVlIHNob3VsZCBiZSB0ZXN0ZWRcbiAgICAvLyBEZWZhdWx0IGJlaGF2aW9yIC0gcmV0dXJucyBcImtleVwiLSBuYW1lZCBwcm9wZXJ0eSB2YWx1ZSBvZiBpdGVtIGlmIGtleSBzaSBwcm92aWRlZCwgb3RoZXJ3aXNlIHRleHRDb250ZW50IG9mIHRoZSBpdGVtJ3MgaHRtbCBlbGVtZW50XG4gICAgcHVibGljIGdldF92YWx1ZShpdGVtOiBhbnksIGtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgdmFyIHJlc3VsdDogc3RyaW5nID0gXCJcIjtcblxuICAgICAgICBpZiAoa2V5KSB7XG4gICAgICAgICAgICByZXN1bHQgPSBpdGVtW2tleV0udG9TdHJpbmcoKTtcbiAgICAgICAgfSBlbHNlIGlmIChpdGVtLmVsZW1lbnQgJiYgaXRlbS5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGl0ZW0uZWxlbWVudC5uYXRpdmVFbGVtZW50LnRleHRDb250ZW50LnRyaW0oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG5cdC8vIEZ1bmN0aW9uIC0gZm9ybWF0cyB0aGUgb3JpZ2luYWwgdGV4dCBiZWZvcmUgbWF0Y2hpbmcgcHJvY2Vzc1xuXHQvLyBEZWZhdWx0IGJlaGF2aW9yIC0gcmV0dXJucyB0ZXh0IHRvIGxvd2VyIGNhc2VcbiAgICBmb3JtYXR0ZXIodmFsdWVUb1Rlc3Q6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB2YWx1ZVRvVGVzdC50b0xvd2VyQ2FzZSgpO1xuXHR9O1xuXG5cdC8vIEZ1bmN0aW9uIC0gZGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBpdGVtIG1ldCB0aGUgY29uZGl0aW9uXG5cdC8vIHZhbHVlVG9UZXN0IC0gdGV4dCB2YWx1ZSB0aGF0IHNob3VsZCBiZSB0ZXN0ZWRcblx0Ly8gaW5wdXRWYWx1ZSAtIHRleHQgdmFsdWUgZnJvbSBpbnB1dCB0aGF0IGNvbmRpdGlvbiBpcyBiYXNlZCBvblxuICAgIC8vIERlZmF1bHQgYmVoYXZpb3IgLSBcImNvbnRhaW5zXCJcbiAgICBtYXRjaEZuKHZhbHVlVG9UZXN0OiBzdHJpbmcsIGlucHV0VmFsdWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdmFsdWVUb1Rlc3QuaW5kZXhPZihpbnB1dFZhbHVlICYmIGlucHV0VmFsdWUudG9Mb3dlckNhc2UoKSB8fCBcIlwiKSA+IC0xO1xuXHR9O1xuXG5cdC8vIEZ1bmN0aW9uIC0gZXhlY3V0ZWQgYWZ0ZXIgbWF0Y2hpbmcgdGVzdCBmb3IgZXZlcnkgbWF0Y2hlZCBpdGVtXG5cdC8vIERlZmF1bHQgYmVoYXZpb3IgLSBzaG93cyB0aGUgaXRlbVxuICAgIG1ldENvbmRpdGlvbkZuKGl0ZW06IGFueSkge1xuICAgICAgICBpZiAoaXRlbS5oYXNPd25Qcm9wZXJ0eShcImhpZGRlblwiKSkge1xuICAgICAgICAgICAgaXRlbS5oaWRkZW4gPSBmYWxzZTtcbiAgICAgICAgfSAgICAgICAgXG4gICAgfTtcblxuXHQvLyBGdW5jdGlvbiAtIGV4ZWN1dGVkIGZvciBldmVyeSBOT1QgbWF0Y2hlZCBpdGVtIGFmdGVyIG1hdGNoaW5nIHRlc3Rcblx0Ly8gRGVmYXVsdCBiZWhhdmlvciAtIGhpZGVzIHRoZSBpdGVtXG4gICAgb3ZlcmR1ZUNvbmRpdGlvbkZuKGl0ZW06IGFueSkge1xuICAgICAgICBpZiAoaXRlbS5oYXNPd25Qcm9wZXJ0eShcImhpZGRlblwiKSkge1xuICAgICAgICAgICAgaXRlbS5oaWRkZW4gPSB0cnVlO1xuICAgICAgICB9ICBcbiAgICB9O1xufVxuXG5ATmdNb2R1bGUoe1xuICAgIGRlY2xhcmF0aW9uczogW0ZpbHRlckRpcmVjdGl2ZSwgRmlsdGVyUGlwZV0sXG4gICAgaW1wb3J0czogW0NvbW1vbk1vZHVsZV0sXG4gICAgZXhwb3J0czogW0ZpbHRlckRpcmVjdGl2ZSwgRmlsdGVyUGlwZV1cbn0pXG5leHBvcnQgY2xhc3MgRmlsdGVyTW9kdWxlIHtcbn0iXX0=
